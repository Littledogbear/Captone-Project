"""
Test Enhanced Knowledge Graph with Specific Malware Samples

This script demonstrates the enhanced knowledge graph visualization with
the specific malware samples from the security report.
"""

import os
import sys
import logging
from pathlib import Path
from datetime import datetime
import webbrowser

sys.path.insert(0, str(Path(__file__).parent))

from src.knowledge_graph.enhanced_malware_graph_builder import EnhancedMalwareGraphBuilder

logging.basicConfig(level=logging.INFO, 
                   format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def generate_specific_malware_data():
    """Generate data with the specific malware samples from the security report."""
    return {
        "malware_analysis": [
            {
                "file": "TrojanSample.exe",
                "classification": "trojan",
                "sha256": "a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2",
                "tags": ["trojan", "stealer", "backdoor"],
                "description": "This trojan establishes persistence through registry modifications and communicates with command and control servers."
            },
            {
                "file": "RansomwareSample.exe",
                "classification": "ransomware",
                "sha256": "b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3",
                "tags": ["ransomware", "encryptor"],
                "description": "This ransomware encrypts user files and demands payment for decryption."
            },
            {
                "file": "BotnetSample.exe",
                "classification": "botnet",
                "sha256": "c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4",
                "tags": ["botnet", "ddos"],
                "description": "This botnet client connects to command and control servers and participates in distributed denial of service attacks."
            }
        ],
        "system_activity": {
            "processes": [
                {
                    "pid": 1234,
                    "name": "TrojanSample.exe",
                    "path": "C:\\Windows\\Temp\\TrojanSample.exe",
                    "command_line": "TrojanSample.exe -s",
                    "user": "SYSTEM",
                    "start_time": "2025-03-30T10:15:30",
                    "severity": "High"
                },
                {
                    "pid": 1235,
                    "name": "powershell.exe",
                    "path": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
                    "command_line": "powershell.exe -EncodedCommand <base64>",
                    "parent_pid": 1234,
                    "user": "SYSTEM",
                    "start_time": "2025-03-30T10:15:35",
                    "severity": "High"
                },
                {
                    "pid": 1236,
                    "name": "RansomwareSample.exe",
                    "path": "C:\\Users\\Admin\\Downloads\\RansomwareSample.exe",
                    "command_line": "RansomwareSample.exe",
                    "user": "Admin",
                    "start_time": "2025-03-30T10:20:15",
                    "severity": "Critical"
                },
                {
                    "pid": 1237,
                    "name": "BotnetSample.exe",
                    "path": "C:\\ProgramData\\BotnetSample.exe",
                    "command_line": "BotnetSample.exe --hidden",
                    "user": "SYSTEM",
                    "start_time": "2025-03-30T10:25:45",
                    "severity": "High"
                }
            ],
            "network": [
                {
                    "process_name": "TrojanSample.exe",
                    "local_addr": "192.168.1.100",
                    "local_port": 49152,
                    "remote_addr": "203.0.113.100",
                    "remote_port": 443,
                    "protocol": "TCP",
                    "state": "ESTABLISHED",
                    "severity": "High"
                },
                {
                    "process_name": "BotnetSample.exe",
                    "local_addr": "192.168.1.100",
                    "local_port": 49153,
                    "remote_addr": "198.51.100.200",
                    "remote_port": 8080,
                    "protocol": "TCP",
                    "state": "ESTABLISHED",
                    "severity": "High"
                }
            ],
            "registry": [
                {
                    "process_name": "TrojanSample.exe",
                    "key": "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run",
                    "value": "TrojanSample",
                    "data": "C:\\Windows\\Temp\\TrojanSample.exe",
                    "action": "write",
                    "severity": "High"
                }
            ],
            "files": [
                {
                    "process_name": "RansomwareSample.exe",
                    "path": "C:\\Users\\Admin\\Documents\\important.docx.encrypted",
                    "action": "create",
                    "severity": "Critical"
                },
                {
                    "process_name": "RansomwareSample.exe",
                    "path": "C:\\Users\\Admin\\Documents\\important.docx",
                    "action": "delete",
                    "severity": "Critical"
                },
                {
                    "process_name": "TrojanSample.exe",
                    "path": "C:\\Windows\\Temp\\config.bin",
                    "action": "create",
                    "severity": "High"
                }
            ]
        },
        "attack_techniques": [
            {
                "id": "T1547.001",
                "name": "Boot or Logon Autostart Execution: Registry Run Keys",
                "confidence": 90,
                "description": "Adversaries may achieve persistence by adding a program to a startup folder or registry run keys."
            },
            {
                "id": "T1059.001",
                "name": "Command and Scripting Interpreter: PowerShell",
                "confidence": 85,
                "description": "Adversaries may abuse PowerShell commands and scripts for execution."
            },
            {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "confidence": 95,
                "description": "Adversaries may encrypt data on target systems or on large numbers of systems in a network to interrupt availability to system and network resources."
            },
            {
                "id": "T1498",
                "name": "Network Denial of Service",
                "confidence": 80,
                "description": "Adversaries may perform Network Denial of Service (DoS) attacks to degrade or block the availability of targeted resources to users."
            }
        ]
    }

def main():
    """Generate and display enhanced knowledge graph with specific malware samples."""
    output_dir = os.path.join(os.path.dirname(__file__), "output", "specific_malware_test")
    os.makedirs(output_dir, exist_ok=True)
    
    sample_data = generate_specific_malware_data()
    
    graph_builder = EnhancedMalwareGraphBuilder()
    graph_builder.build_graph(sample_data)
    
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    html_path = os.path.join(output_dir, f"specific_malware_graph_{timestamp}.html")
    
    if not html_path.endswith('.html'):
        html_path = html_path.replace('.json', '.html')
        if not html_path.endswith('.html'):
            html_path += '.html'
    
    graph_builder.export_graph(html_path)
    logger.info(f"Enhanced knowledge graph exported to {html_path}")
    
    webbrowser.open(f"file://{html_path}")
    
    print(f"\nEnhanced knowledge graph visualization available at: {html_path}")
    
    return html_path

if __name__ == "__main__":
    main()
