# MalwareBazaar API Integration Guide

This guide provides detailed instructions for integrating with the MalwareBazaar API to retrieve malware samples for analysis in the Cyber Attack Tracer project.

## 1. API Overview

MalwareBazaar provides a REST API for programmatic access to its malware repository. The API endpoint is:

```
https://mb-api.abuse.ch/api/v1/
```

**Important Notes:**
- The API cannot be accessed directly through a browser
- All requests must be made programmatically with proper parameters and authentication headers
- The API requires POST requests with specific query parameters
- Authentication is performed using an API key

## 2. API Key Configuration

### 2.1 Setting the API Key

The API key should be stored as an environment variable to avoid hardcoding it in scripts:

```bash
# Set your MalwareBazaar API key as an environment variable
export Malware_Bazzar_personal_key="your_api_key_here"

# Verify the key is set correctly
echo $Malware_Bazzar_personal_key
```

### 2.2 Retrieving the API Key in Python

```python
import os

def get_api_key():
    """Get the MalwareBazaar API key from environment variables."""
    api_key = os.environ.get('Malware_Bazzar_personal_key')
    if not api_key:
        print("Error: MalwareBazaar API key not found.")
        return None
    return api_key
```

## 3. API Request Structure

### 3.1 Basic Request Structure

All requests to the MalwareBazaar API must be POST requests with the following structure:

```python
import requests

url = "https://mb-api.abuse.ch/api/v1/"
headers = {
    "API-KEY": api_key,
    "Content-Type": "application/x-www-form-urlencoded"
}
data = {
    "query": "get_recent",
    "limit": 10
}

response = requests.post(url, data=data, headers=headers)
```

### 3.2 Common Query Types

The API supports several query types:

| Query Type | Description | Required Parameters |
|------------|-------------|---------------------|
| `get_recent` | Get recent samples | `limit` |
| `get_file` | Get a specific file | `sha256_hash` |
| `get_taginfo` | Get samples with a specific tag | `tag`, `limit` |
| `get_malware` | Get samples by malware family | `family`, `limit` |

### 3.3 Example Queries

#### Get Recent Samples

```python
data = {
    "query": "get_recent",
    "limit": 10
}
```

#### Get Samples by Tag

```python
data = {
    "query": "get_taginfo",
    "tag": "ransomware",
    "limit": 5
}
```

#### Get a Specific Sample

```python
data = {
    "query": "get_file",
    "sha256_hash": "3da500d9dc1a24e1c4a55146a1dd85088c07cde5cb684f1ad4238b78b74cd5c1"
}
```

## 4. Processing API Responses

### 4.1 Response Structure

The API returns JSON responses with the following structure:

```json
{
  "query_status": "ok",
  "data": [
    {
      "sha256_hash": "3da500d9dc1a24e1c4a55146a1dd85088c07cde5cb684f1ad4238b78b74cd5c1",
      "file_name": "malware_sample.exe",
      "file_type": "exe",
      "file_size": 542282,
      "tags": ["ransomware", "apos"],
      "first_seen": "2025-04-07 07:53:31",
      "signature": "Apos"
    }
  ]
}
```

### 4.2 Error Handling

The API may return errors in the following format:

```json
{
  "query_status": "no_results"
}
```

Common error codes include:
- `no_results`: No samples match the query
- `no_selector`: Missing required parameter
- `invalid_hash`: The provided hash is invalid
- `unauthorized`: Invalid or missing API key

### 4.3 Processing Sample Metadata

```python
def process_samples(api_response):
    """Process downloaded samples."""
    samples = api_response.get("data", [])
    if not samples:
        print("No samples found in API response.")
        return False
    
    print(f"Processing {len(samples)} samples...")
    
    for sample in samples:
        sha256_hash = sample.get("sha256_hash")
        if not sha256_hash:
            print("Sample missing SHA256 hash, skipping.")
            continue
        
        # Save metadata
        metadata_path = os.path.join(METADATA_DIR, f"{sha256_hash}.json")
        with open(metadata_path, "w") as f:
            json.dump(sample, f, indent=2)
        print(f"Saved metadata to {metadata_path}")
```

## 5. Downloading Sample Files

### 5.1 Sample Download Request

```python
def download_sample(sha256_hash):
    """Download a specific sample by SHA256 hash."""
    url = "https://mb-api.abuse.ch/api/v1/"
    api_key = get_api_key()
    
    if not api_key:
        return None
    
    sample_path = os.path.join(SAMPLES_DIR, f"{sha256_hash}.zip")
    
    if os.path.exists(sample_path):
        print(f"Sample {sha256_hash} already exists locally")
        return sample_path
    
    data = {
        "query": "get_file",
        "sha256_hash": sha256_hash
    }
    
    headers = {
        "API-KEY": api_key
    }
    
    try:
        print(f"Downloading sample {sha256_hash}")
        response = requests.post(url, data=data, headers=headers)
        
        # Check for HTTP errors
        if response.status_code != 200:
            print(f"HTTP Error: {response.status_code}")
            return None
        
        # Check if response is a ZIP file
        content_type = response.headers.get('Content-Type', '')
        if 'application/zip' not in content_type and 'application/octet-stream' not in content_type:
            print(f"Unexpected content type: {content_type}")
            return None
        
        # Save the sample
        with open(sample_path, "wb") as f:
            f.write(response.content)
        
        print(f"Sample saved to {sample_path}")
        return sample_path
    except Exception as e:
        print(f"Error downloading sample {sha256_hash}: {str(e)}")
        return None
```

### 5.2 Safety Considerations

- Downloaded samples are password-protected ZIP files
- The standard password is `infected`
- Never extract or execute samples outside of a secure sandbox environment
- Always handle samples as potentially dangerous malware

## 6. Integration with Cyber Attack Tracer

### 6.1 Sample Directory Structure

The Cyber Attack Tracer project uses the following directory structure for malware samples:

```
samples/
└── malwarebazaar/
    ├── metadata/
    │   ├── sample1_hash.json
    │   ├── sample2_hash.json
    │   └── ...
    ├── sample1_hash.zip
    ├── sample2_hash.zip
    └── ...
```

### 6.2 Sample Analysis Integration

```python
def analyze_samples():
    """Analyze downloaded samples."""
    from src.ember_integration.malware_categorizer import MalwareCategorizer
    from src.ioc_integration.ioc_analyzer import IOCAnalyzer
    
    # Initialize analyzers
    malware_categorizer = MalwareCategorizer()
    ioc_analyzer = IOCAnalyzer()
    
    # Get all metadata files
    metadata_files = glob.glob(os.path.join(METADATA_DIR, "*.json"))
    
    for metadata_file in metadata_files:
        with open(metadata_file, "r") as f:
            metadata = json.load(f)
        
        sha256_hash = metadata.get("sha256_hash")
        if not sha256_hash:
            continue
        
        # Analyze sample
        sample_path = os.path.join(SAMPLES_DIR, f"{sha256_hash}.zip")
        if not os.path.exists(sample_path):
            continue
        
        # Categorize malware
        category = malware_categorizer.categorize(metadata)
        print(f"Sample {sha256_hash} categorized as: {category}")
        
        # Extract IOCs
        iocs = ioc_analyzer.extract_iocs(metadata)
        print(f"Extracted {len(iocs)} IOCs from sample {sha256_hash}")
```

## 7. Troubleshooting

### 7.1 API Connection Issues

If you encounter connection issues:

1. Verify your API key is correct
2. Check your internet connection
3. Ensure you're using the correct API endpoint
4. Verify the required parameters for your query type

### 7.2 Sample Download Issues

If sample downloads fail:

1. Verify you have permission to download samples with your API key
2. Check if the sample exists in MalwareBazaar
3. Ensure you have sufficient disk space
4. Verify you have write permissions to the samples directory

### 7.3 Rate Limiting

MalwareBazaar may implement rate limiting. If you encounter rate limiting:

1. Reduce the frequency of your requests
2. Implement exponential backoff for retries
3. Cache results to avoid redundant requests

## 8. Example Implementation

See the `test_malwarebazaar_samples.py` file in the project for a complete implementation of MalwareBazaar API integration.

```python
# Example usage
if __name__ == "__main__":
    # Set up directories
    os.makedirs(SAMPLES_DIR, exist_ok=True)
    os.makedirs(METADATA_DIR, exist_ok=True)
    
    # Download recent samples
    download_samples("get_recent", 5)
    
    # Download samples by tag
    download_samples("get_taginfo", 3, "ransomware")
    
    # Analyze samples
    analyze_samples()
```
